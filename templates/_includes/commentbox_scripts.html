{% macro comments_script_commentbox(project, identifier) %}
<div class="commentbox"></div>
<script src="{{ SITEURL }}/{{ THEME_STATIC_DIR | default('theme') }}/commentbox/commentBox.min.js"></script>
<script>
    // Get current theme colors for CommentBox
    function getCommentBoxTheme() {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        const isDark = currentTheme === 'dark';

        return {
            // Match Bootstrap 5 dark theme colors exactly
            // Note: CommentBox.io only supports backgroundColor, textColor, and subtextColor
            // The textarea styling is controlled by CommentBox.io's iframe and may not fully respect these colors
            backgroundColor: isDark ? '#212529' : '#ffffff',
            textColor: isDark ? '#dee2e6' : '#212529',
            subtextColor: isDark ? '#adb5bd' : '#6c757d'
        };
    }

    // Initialize CommentBox with theme
    const theme = getCommentBoxTheme();
    commentBox("{{ project }}", {
        createBoxId: "{{ identifier }}",
        backgroundColor: theme.backgroundColor,
        textColor: theme.textColor,
        subtextColor: theme.subtextColor,
        onCommentCount(count) {
            const ele = document.querySelector("#comment-accordion-toggle")
            if (ele) {
                if (count > 0) {
                    ele.innerText = `${count} Comment${count > 1 ? 's' : ''}`
                } else {
                    ele.innerText = 'Comments'
                }
            }
        }
    });

    // Watch for theme changes and reload CommentBox
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                // Reload the page to refresh CommentBox with new theme
                // CommentBox doesn't support dynamic theme switching, so we need to reload
                const commentboxContainer = document.querySelector('.commentbox');
                if (commentboxContainer && commentboxContainer.querySelector('iframe')) {
                    location.reload();
                }
            }
        });
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
    });
</script>
{% endmacro %}
